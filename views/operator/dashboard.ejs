<%- include('../partials/header') %>

<div class="container" style="padding: 30px 20px; min-height: 60vh;">
    <div class="section-header">
        <h3 class="section-title">Operator Dashboard: <%= business.name %></h3>
        <div class="user-actions">
            <span style="font-weight: 600; color: var(--text-muted); margin-right: 10px;">Hi, <%= user.name %></span>
            <a href="/logout" class="slide-btn" style="padding: 8px 20px; font-size: 13px; background: #fee2e2; color: #dc2626; border: none;">Logout</a>
        </div>
    </div>

    <!-- Flash Messages -->
    <% if (locals.success && locals.success.length > 0) { %>
        <div style="color: #155724; background-color: #d4edda; border-color: #c3e6cb; padding: 15px; margin-bottom: 20px; border-radius: var(--radius-sm);">
            <%= success %>
        </div>
    <% } %>
    <% if (locals.error && locals.error.length > 0) { %>
        <div style="color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: 15px; margin-bottom: 20px; border-radius: var(--radius-sm);">
            <%= error %>
        </div>
    <% } %>

    <!-- Listings Section -->
    <div style="margin-bottom: 40px; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <h4 style="margin: 0; color: var(--secondary);">Manage Listings</h4>
            <a href="/operator/listings/add" class="slide-btn" style="padding: 6px 12px; font-size: 12px;">+ Add New</a>
        </div>
        
        <% if (!listings || listings.length === 0) { %>
             <p style="color: var(--text-muted); font-size: 13px;">No listings found.</p>
        <% } else { %>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                <% listings.forEach(item => { %>
                    <div style="border: 1px solid #eee; border-radius: var(--radius-sm); overflow: hidden;">
                         <img src="<%= item.image %>" alt="<%= item.name %>" style="width: 100%; height: 120px; object-fit: cover; background: #f9fafb;">
                         <div style="padding: 10px;">
                             <h5 style="margin: 0 0 5px 0; font-size: 14px;"><%= item.name %></h5>
                             <p style="margin: 0 0 10px 0; font-size: 12px; color: var(--text-muted);">R<%= item.price.toFixed(2) %></p>
                             <div style="display: flex; gap: 5px;">
                                 <a href="/operator/listings/<%= item._id %>/edit" style="flex: 1; text-align: center; background: var(--bg-input); color: var(--secondary); font-size: 11px; padding: 4px; border-radius: 3px; text-decoration: none;">Edit</a>
                                 <form action="/operator/listings/<%= item._id %>/delete" method="POST" onsubmit="return confirm('Delete?');" style="margin: 0; flex: 1;">
                                     <button type="submit" style="width: 100%; background: #fee2e2; color: #dc2626; border: none; font-size: 11px; padding: 4px; border-radius: 3px; cursor: pointer;">Delete</button>
                                 </form>
                             </div>
                         </div>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>

    <!-- Tasks Section (For Service SMEs) -->
    <% if (business.category === 'service' && tasks && tasks.length > 0) { %>
        <div style="margin-top: 40px;">
             <h3 class="section-title">Service Tasks Queue</h3>
             <div style="display: flex; flex-direction: column; gap: 20px;">
                <% tasks.forEach(task => { %>
                    <div style="background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); padding: 20px; border-left: 5px solid #9c27b0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <div>
                                <span style="font-size: 12px; color: var(--text-muted);">CUSTOMER</span><br>
                                <strong><%= task.consumer.name %></strong>
                            </div>
                            <div style="text-align: right;">
                                <span style="font-size: 12px; color: var(--text-muted);">STATUS</span><br>
                                <span class="status-badge <%= task.status.toLowerCase().replace(' ', '-') %>" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #f3e5f5; color: #9c27b0;"><%= task.status %></span>
                            </div>
                        </div>
                        
                        <!-- Task Answers -->
                        <div style="background: #f9fafb; padding: 15px; border-radius: var(--radius-sm); margin-bottom: 15px;">
                            <table style="width: 100%; font-size: 14px;">
                                <% task.answers.forEach(ans => { %>
                                    <tr>
                                        <td style="color: var(--text-muted); padding: 4px 0; width: 40%;"><%= ans.question %>:</td>
                                        <td style="font-weight: 600; padding: 4px 0;"><%= ans.answer %></td>
                                    </tr>
                                <% }) %>
                            </table>
                        </div>

                        <!-- Actions -->
                        <form action="/operator/tasks/update-status" method="POST" style="margin: 0; display: flex; justify-content: flex-end; gap: 10px;">
                            <input type="hidden" name="taskId" value="<%= task._id %>">
                            
                            <% if (task.status === 'Pending') { %>
                                <button type="submit" name="status" value="In Progress" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Start Task</button>
                            <% } else if (task.status === 'In Progress') { %>
                                <button type="submit" name="status" value="Completed" style="background: var(--success); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Mark Complete</button>
                            <% } else { %>
                                <button disabled style="background: #eee; color: #999; border: none; padding: 8px 16px; border-radius: 4px;">Completed</button>
                            <% } %>
                        </form>
                    </div>
                <% }) %>
             </div>
        </div>
    <% } %>

    <% if (orders.length === 0) { %>
        <div style="text-align: center; padding: 60px 20px; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">
            <div style="font-size: 48px; color: var(--text-muted); margin-bottom: 20px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 style="color: var(--secondary);">All Caught Up!</h3>
            <p style="color: var(--text-muted); max-width: 400px; margin: 0 auto;">There are no pending orders or bookings in your queue.</p>
        </div>
    <% } else { %>
        <div style="display: flex; flex-direction: column; gap: 25px;">
            <% orders.forEach(order => { %>
                <!-- Filter items belonging to THIS business -->
                <% const myItems = order.items.filter(item => item.business.toString() === business._id.toString()); %>
                
                <% if (myItems.length > 0) { %>
                    <div style="background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); overflow: hidden; border-left: 5px solid var(--primary);">
                        <div style="padding: 15px 20px; background: #f9fafb; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                             <div>
                                <span style="font-size: 12px; color: var(--text-muted);">CUSTOMER</span><br>
                                <strong style="color: var(--secondary);"><%= order.user.name %></strong> 
                                <a href="tel:<%= order.user.phone %>" style="font-size: 12px; color: var(--primary); text-decoration: none;"><i class="fas fa-phone"></i> Call</a>
                             </div>
                             <div style="text-align: right;">
                                <span style="font-size: 12px; color: var(--text-muted);">DATE</span><br>
                                <span style="font-size: 13px;"><%= new Date(order.createdAt).toLocaleDateString() %></span>
                             </div>
                        </div>

                        <div style="padding: 0;">
                            <% myItems.forEach(item => { %>
                                <div style="padding: 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                                    <div style="display: flex; align-items: center; gap: 15px; flex: 2;">
                                        <div style="width: 50px; height: 50px; background: #f9fafb; border-radius: 4px; overflow: hidden;">
                                            <img src="<%= item.listing ? item.listing.image : '' %>" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; font-size: 16px;"><%= item.name %></h4>
                                            <div style="font-size: 12px; color: var(--text-muted);">Qty: <%= item.quantity %></div>
                                        </div>
                                    </div>

                                    <div style="flex: 1; min-width: 200px; text-align: right;">
                                        <form action="/operator/orders/update-status" method="POST">
                                            <input type="hidden" name="orderId" value="<%= order._id %>">
                                            <input type="hidden" name="itemId" value="<%= item._id %>">
                                            
                                            <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 5px;">CURRENT STATUS</label>
                                            <select name="status" onchange="this.form.submit()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc; width: 100%; max-width: 150px; 
                                                background-color: <%= item.status === 'completed' ? '#dcfce7' : (item.status === 'pending' ? '#ffedd5' : '#e0f2fe') %>;">
                                                <option value="pending" <%= item.status === 'pending' ? 'selected' : '' %>>Pending</option>
                                                <option value="processing" <%= item.status === 'processing' ? 'selected' : '' %>>Processing</option>
                                                <option value="completed" <%= item.status === 'completed' ? 'selected' : '' %>>Completed</option>
                                            </select>
                                        </form>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                <% } %>
            <% }) %>
        </div>
    <% } %>
</div>

<%- include('../partials/footer') %>
