<%- include('../partials/header') %>

<div class="container" style="padding: 30px 20px; min-height: 70vh;">
    <div class="chat-wrapper" style="max-width: 600px; margin: 0 auto; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-md); display: flex; flex-direction: column; height: 70vh;">
        
        <!-- Header -->
        <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; background: #f9fafb; border-radius: var(--radius-md) var(--radius-md) 0 0;">
            <img src="<%= business.logo || '/public/assets/default-business.png' %>" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
            <div>
                <h4 style="margin: 0; color: var(--secondary);"><%= business.name %></h4>
                <span style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-circle" style="color: var(--success); font-size: 8px;"></i> Online Assistant</span>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-box" style="flex: 1; padding: 20px; overflow-y: auto; background: white;">
            
            <!-- Initial Greeting -->
            <div class="message bot">
                <div class="bubble">
                    Hi <%= user.name %>! Welcome to <%= business.name %>. Let's get your service request sorted.
                </div>
            </div>
            
            <!-- Dynamic Messages will appear here -->

        </div>

        <!-- Input Area -->
        <div id="input-area" style="padding: 15px 20px; border-top: 1px solid #eee; background: #f9fafb; border-radius: 0 0 var(--radius-md) var(--radius-md);">
            <!-- Inputs are injected dynamically based on question type -->
            <div id="dynamic-input-container">
                <button id="start-btn" class="auth-btn" style="width: 100%;">Start Service Request</button>
            </div>
        </div>
    </div>
</div>

<style>
    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }
    .message.bot {
        align-items: flex-start;
    }
    .message.user {
        align-items: flex-end;
    }
    .bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
    }
    .message.bot .bubble {
        background: #f0f2f5;
        color: var(--text-main);
        border-bottom-left-radius: 4px;
    }
    .message.user .bubble {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .option-btn {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        color: var(--text-main);
        cursor: pointer;
        transition: 0.2s;
        text-align: left;
    }
    .option-btn:hover {
        background: #f0f2f5;
        border-color: #bbb;
    }

    .typing-indicator {
        padding: 10px;
        font-size: 12px;
        color: #999;
        font-style: italic;
    }
</style>

<script>
    const businessId = "<%= business._id %>";
    const chatBox = document.getElementById('chat-box');
    const inputContainer = document.getElementById('dynamic-input-container');
    let sessionId = null;

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        div.innerHTML = `
            <div class="bubble">${text}</div>
            <span style="font-size: 10px; color: #aaa; margin-top: 4px; margin-${sender === 'user' ? 'right' : 'left'}: 5px;">
                ${time}
            </span>
        `;
        chatBox.appendChild(div);
        scrollToBottom();
    }

    function renderInput(step) {
        inputContainer.innerHTML = '';
        
        if (!step) return; // Should not happen unless completed

                if (step.type === 'multiple_choice') {
                    step.options.forEach(opt => {
                        const label = typeof opt === 'object' ? opt.label : opt;
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.textContent = label;
                        btn.onclick = () => submitAnswer(label);
                        inputContainer.appendChild(btn);
                    });
                }          else if (step.type === 'yes_no') {
            ['Yes', 'No'].forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.onclick = () => submitAnswer(opt);
                inputContainer.appendChild(btn);
            });
        }
        else if (step.type === 'text' || step.type === 'number') {
            const input = document.createElement('input');
            input.type = step.type === 'number' ? 'number' : 'text';
            input.className = 'auth-input'; // reusing class
            input.style.marginBottom = '10px';
            input.placeholder = step.type === 'number' ? 'Enter a number...' : 'Type your answer...';
            
            const btn = document.createElement('button');
            btn.className = 'auth-btn';
            btn.textContent = 'Send';
            btn.style.width = '100%';
            btn.onclick = () => {
                const val = input.value.trim();
                if (!val) return;

                if (step.type === 'number') {
                     const num = parseFloat(val);
                     if (isNaN(num) || num <= 0) {
                         alert('Please enter a valid positive number.');
                         return;
                     }
                }
                submitAnswer(val);
            };
            
            // Allow Enter key
            input.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') btn.click();
            });

            inputContainer.appendChild(input);
            inputContainer.appendChild(btn);
            input.focus();
        }
        else if (step.type === 'file') {
            const input = document.createElement('input');
            input.type = 'file';
            input.className = 'auth-input';
            input.style.marginBottom = '10px';
            
            const btn = document.createElement('button');
            btn.className = 'auth-btn';
            btn.textContent = 'Upload File';
            btn.style.width = '100%';
            
            btn.onclick = async () => {
                if(input.files.length === 0) return alert('Please select a file');
                
                // Show uploading state
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                btn.disabled = true;

                const formData = new FormData();
                formData.append('sessionId', sessionId);
                formData.append('file', input.files[0]);

                try {
                    const res = await fetch('/service/upload', {
                        method: 'POST',
                        body: formData // No Content-Type header, browser sets it with boundary
                    });
                    const data = await res.json();

                    if (data.error) {
                        alert(data.error);
                        btn.innerHTML = 'Upload File';
                        btn.disabled = false;
                        return;
                    }

                    // Show user message (link to file)
                    addMessage(`Uploaded: <a href="${data.filePath}" target="_blank">View File</a>`, 'user');

                    if (data.completed) {
                        addMessage("Thank you! Your request has been submitted to an operator.", 'bot');
                        inputContainer.innerHTML = `
                            <div style="text-align: center; padding: 10px;">
                                <a href="/sme/dashboard" class="auth-btn" style="text-decoration: none; display: block; width: 100%;">Done</a>
                            </div>`; 
                    } else {
                        addMessage(data.step.question, 'bot');
                        renderInput(data.step);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Upload failed');
                    btn.innerHTML = 'Upload File';
                    btn.disabled = false;
                }
            };

            inputContainer.appendChild(input);
            inputContainer.appendChild(btn);
        }
        else if (step.type === 'review_summary') {
            // Render Summary Table or List
            const container = document.createElement('div');
            container.style.maxHeight = '200px';
            container.style.overflowY = 'auto';
            container.style.marginBottom = '15px';
            container.style.fontSize = '13px';
            container.style.border = '1px solid #eee';
            container.style.borderRadius = '8px';
            container.style.padding = '10px';
            container.style.background = '#fff';

            step.responses.forEach(item => {
                // Skip the confirmation itself if it exists (shouldn't yet)
                if(item.answer === 'CONFIRMED_SUMMARY') return;

                const row = document.createElement('div');
                row.style.marginBottom = '8px';
                row.style.paddingBottom = '8px';
                row.style.borderBottom = '1px solid #f0f0f0';
                
                let displayAnswer = item.answer;
                if (item.type === 'file') {
                    displayAnswer = `<a href="${item.answer}" target="_blank">View File</a>`;
                }

                row.innerHTML = `
                    <strong style="display:block; color:var(--secondary);">${item.question}</strong>
                    <span style="color:var(--text-main);">${displayAnswer}</span>
                `;
                container.appendChild(row);
            });

            const btn = document.createElement('button');
            btn.className = 'auth-btn';
            btn.textContent = 'Confirm & Submit';
            btn.style.width = '100%';
            btn.style.backgroundColor = 'var(--success)';
            btn.onclick = () => submitAnswer('CONFIRMED_SUMMARY');

            inputContainer.appendChild(container);
            inputContainer.appendChild(btn);
        }
        else {
            // Fallback
             addMessage("Input type not supported yet.", 'bot');
        }
    }

    async function submitAnswer(answer) {
        // Add user message
        addMessage(answer, 'user');
        
        // Show loading/typing
        inputContainer.innerHTML = '<div class="typing-indicator">Assistant is typing...</div>';

        try {
            const res = await fetch('/service/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId, answer })
            });
            const data = await res.json();

            if (data.completed) {
                addMessage("Thank you! Your request has been submitted to an operator.", 'bot');
                inputContainer.innerHTML = `
                    <div style="text-align: center; padding: 10px;">
                        <a href="/sme/dashboard" class="auth-btn" style="text-decoration: none; display: block; width: 100%;">Done</a>
                    </div>`; // Or redirect to orders page
            } else {
                // Next Question
                addMessage(data.step.question, 'bot');
                renderInput(data.step);
            }

        } catch (err) {
            console.error(err);
            addMessage("Something went wrong. Please try again.", 'bot');
        }
    }

    // Start Session
    document.getElementById('start-btn').addEventListener('click', async () => {
        inputContainer.innerHTML = '<div class="typing-indicator">Starting...</div>';
        
        try {
            const res = await fetch('/service/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ businessId })
            });
            const data = await res.json();
            
            if (data.error) {
                addMessage(data.error, 'bot');
                inputContainer.innerHTML = '';
                return;
            }

            sessionId = data.sessionId;
            addMessage(data.step.question, 'bot');
            renderInput(data.step);

        } catch (err) {
            console.error(err);
            addMessage("Could not start chat. Refresh page.", 'bot');
        }
    });

</script>

<%- include('../partials/footer') %>
